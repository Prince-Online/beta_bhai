<style>
    body{ font-family: Arial , sans-serif; margin: 0; background-color: #121212; color: #fff; }
    .divider{ flex-grow: 1; border: none; height: 1px; background: #00ff7f; margin-left: 10px; }
    .header{ display: flex; align-items: center; justify-content: space-between; padding: 10px 20px; background-color: #1f1f1f; margin-bottom: 10px; }
    .app-icon{background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);width: 35px; border-radius: 125px;}
    .news-card{ display: flex; background: #1f1f1f; border-radius: 10px; overflow: hidden; margin-bottom: -10px; height: 15%; }
    .news-image{ width: 120px; object-fit: cover; }
    .news-details{ padding: 10px; flex-grow: 1; }
    .news-title{ font-size: 18px; color: #00ff7f; width: 160px; }
    .news-username{ font-size: 14px; color: #aaa; width: 100px;}
    .news-des{ font-size: 14px; color: #ddd; width: 180px; }
    .news-section{ padding: 20px; }
    .news-title,.news-username,.news-des{ overflow-x: hidden; text-overflow: ellipsis; white-space: nowrap; }
    /* HTML: <div class="loader"></div> */
.loader {
  --s: 64px;
  width: var(--s);
  aspect-ratio: 2;
  --_g: #fff 90%,#0000;
  background: 
    radial-gradient(farthest-side,var(--_g)) 0   50%/25% 50%,
    radial-gradient(farthest-side at bottom,var(--_g)) 50%  calc(50% - var(--s)/16)/25% 25%,
    radial-gradient(farthest-side at top   ,var(--_g)) 50%  calc(50% + var(--s)/16)/25% 25%,
    radial-gradient(farthest-side at bottom,var(--_g)) 100% calc(50% - var(--s)/16)/25% 25%,
    radial-gradient(farthest-side at top   ,var(--_g)) 100% calc(50% + var(--s)/16)/25% 25%;
  background-repeat: no-repeat;
  animation: l14 1s infinite;
}
@keyframes l14 {
    25%  {background-position:0    50%,50% 0,50% 100%,100% 0,100% 100%}
    50%  {background-position:100% 50%,0   0,0   100%,50%  0,50%  100%}
    75%,
    100% {background-position:100% 50%,0 calc(50% - var(--s)/16),0 calc(50% + var(--s)/16),50% calc(50% - var(--s)/16),50% calc(50% + var(--s)/16)}
}
.loader-papa{ display: flex; justify-content: center; align-items: center; height: 80%; }
</style>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="UTF-8">
<div class="header">
    <img src="https://i.ibb.co/vckRpWn/icon.png" class="app-icon">
    <hr class="divider">
</div>
<div id="news-container"><!-- News will be dynamically populated here --></div>
<div class="loader-papa">
<div id="loader" class="loader">
<!--Loader-->
</div>
</div>
<script>
    const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxO5RsDcXMw0SGDDPlUUp2t2tkK4PN_5vKzGfnmWqcj-hxsFYYk3Snksu6E04zDDFkY/exec';
const newsContainer = document.getElementById('news-container');
const loaderElement = document.getElementById('loader');

let newsItems = [];

function showLoader() {
    loaderElement.style.display = 'block';
}

function hideLoader() {
    loaderElement.style.display = 'none';
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

async function fetchNews() {
    const username = localStorage.getItem('YopshLoc_Username');
    if (!username) {
        console.log('Please log in first');
        return;
    }

    showLoader();
    try {
        const response = await fetch(SHEET_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                action: 'fetchNews', 
                username: username 
            })
        });
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }

        newsItems = data.news;

        const shuffledNews = shuffleArray(newsItems);
        renderNews(shuffledNews);
    } catch (error) {
        console.error('Error:', error);
        console.log('Failed to fetch news');
    } finally {
        hideLoader();
    }
}

function renderNews(newsItems) {
    newsContainer.innerHTML = newsItems.map((item, index) => `
        <section class="news-section">
        <div class="news-card" data-row="${item.rowIndex}">
            <img src="${item[3]}" alt="News Image" 
                 onclick="openNewsDetail(${index})" 
                 class="news-image">
        <div class="news-details">
            <h2 class="news-title">${item[1]}</h2>
            <p class="news-username">By ${item[0]}</p>
            <p class="news-des">${item[2]}</p>
            </div>
        </div>
        </section>
    `).join('');

    hideLoader();
}

function openNewsDetail(index) {
    const selectedNews = {
        username: newsItems[index][0],
        title: newsItems[index][1],
        content: newsItems[index][2],
        imageUrl: newsItems[index][3],
        likes: newsItems[index][4] || 0,
        dislikes: newsItems[index][5] || 0,
        rowIndex: newsItems[index].rowIndex
    };

    localStorage.setItem('selectedNews', JSON.stringify(selectedNews));
    window.location.href = 'mainpart.html';
}

async function handleReaction(rowIndex, type) {
    const username = localStorage.getItem('YopshLoc_Username');
    if (!username) return;

    const newsCard = document.querySelector(`[data-row="${rowIndex}"]`);
    if (!newsCard) return;

    const likeBtn = newsCard.querySelector('.like-btn');
    const dislikeBtn = newsCard.querySelector('.dislike-btn');

    if (likeBtn.disabled || dislikeBtn.disabled) return;

    showLoader();
    try {
        const response = await fetch(SHEET_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'recordReaction',
                username: username,
                type: type,
                rowIndex: rowIndex
            })
        });

        const data = await response.json();
        if (data.success) {
            newsCard.querySelector('.like-count').textContent = data.likes;
            newsCard.querySelector('.dislike-count').textContent = data.dislikes;
            likeBtn.disabled = true;
            dislikeBtn.disabled = true;

            if (type === 'like') {
                likeBtn.classList.add('bg-green-700');
            } else {
                dislikeBtn.classList.add('bg-red-700');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        console.log('Failed to record reaction');
    } finally {
        hideLoader();
    }
}

document.addEventListener('DOMContentLoaded', fetchNews);
</script>